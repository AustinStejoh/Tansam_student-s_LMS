{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ course.title }} | Course Details</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css">
    <style>
        :root {
            --brand-900: #0f2557;
            --brand-800: #1e3a8a;
            --brand-600: #3747c7;
            --accent-600: #d97706;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e5e7eb;
            --text: #1e293b;
            --muted: #475569;
        }
        body { margin: 0; font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:
            radial-gradient(900px 500px at 110% 10%, #fef3c7 0%, transparent 55%), var(--bg); color: var(--text); }

        .layout { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--brand-800); color: #fff; display: flex; flex-direction: column; padding: 1.5rem; box-shadow: 2px 0 8px rgba(0,0,0,0.08); position: relative; z-index: 10; }
        .sidebar h2 { font-size: 1.15rem; margin-bottom: 1.2rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.6rem; }
        .sidebar a { color: #e0e7ff; text-decoration: none; margin: 0.35rem 0; padding: 0.6rem; border-radius: 8px; transition: background 0.25s; display: block; }
        .sidebar a:hover { background: rgba(255,255,255,0.15); }

        /* Mobile sidebar overlay */
        .sidebar-toggle { display: none; background: transparent; border: 0; font-size: 1.4rem; cursor: pointer; color: var(--brand-800); }

        /* Main content */
        .content { flex-grow: 1; padding: 1.5rem 2rem; }
        .toolbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
        .theme-btn { border: 1px solid var(--border); padding: 0.45rem 0.85rem; border-radius: 999px; font-size: 0.95rem; text-decoration: none; color: var(--brand-800); }
        .topnav { display: flex; gap: .5rem; flex-wrap: wrap; }
        .topnav a { text-decoration: none; color: #1e293b; background: #eef2ff; border: 1px solid #dbe2ff; padding: .5rem .8rem; border-radius: 8px; font-weight: 600; }
        .topnav a:hover { background: #e0e7ff; }

        .course-header { background: var(--surface); padding: 0.75rem 1.25rem; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 0.5rem; border: 1px solid var(--border); }
        .course-header h1 { color: var(--brand-800); font-size: 1.5rem; margin: 0 0 0.3rem 0; }
        .course-header p { color: var(--muted); line-height: 1.5; margin: 0; font-size: 0.95rem; }

        /* Layout: sidebar + detail */
        .content-grid { display: grid; grid-template-columns: 280px 1fr; gap: 1rem; align-items: start; margin: 0; padding: 0; }
        .content-grid > section { margin: 0; padding: 0; }
        @media (max-width: 960px) { .content-grid { grid-template-columns: 1fr; } }

        /* Sidebar list */
        .module-list { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .module-list-header { padding: 1rem 1rem; font-weight: 700; color: var(--brand-900); border-bottom: 1px solid var(--border); background: #f8faff; }
        .module-items { list-style: none; margin: 0; padding: 0.25rem; max-height: 70vh; overflow: auto; }
        .module-item { margin: 0.25rem 0; }
        .module-link { display: block; padding: 0.7rem 0.9rem; border-radius: 8px; color: var(--text); text-decoration: none; border: 1px solid transparent; }
        .module-link:hover { background: #f3f6ff; border-color: #e2e8ff; }
        .module-link.active { background: #e6eeff; border-color: #c8d7ff; color: var(--brand-900); font-weight: 700; }

        /* Video player */
        section > section.player { margin: 0; }
        .player { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.06); overflow: hidden; margin: 0 0 0.5rem 0; }
        .player-header { display: flex; justify-content: space-between; align-items: center; padding: 0.65rem 0.9rem; border-bottom: 1px solid var(--border); }
        .player-title { font-weight: 600; color: var(--brand-900); font-size: 0.95rem; margin: 0; }
        .aspect { position: relative; width: 100%; padding-top: 0%; }
        .aspect > video, .aspect > iframe { position: absolute; inset: 0; width: 100%; height: 100%; background: #000; }

        /* Topic cards */
        .topics { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.25rem; }
        .topic-card { background: var(--surface); border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.06); padding: 1.25rem 1.25rem; transition: transform 0.2s ease, box-shadow 0.2s ease; border: 1px solid var(--border); }
        .topic-card:hover { transform: translateY(-3px); box-shadow: 0 6px 14px rgba(0,0,0,0.08); }
        .topic-card h3 { color: var(--brand-900); margin-bottom: 0.5rem; font-size: 1.1rem; }
        .topic-section p { margin: 0.4rem 0; color: var(--muted); }
        .topic-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }

        .no-data { color: #94a3b8; font-style: italic; }

        /* Buttons */
        .btn { display: inline-block; padding: 0.5rem 0.9rem; background: var(--brand-800); color: #fff; border-radius: 8px; text-decoration: none; font-size: 0.9rem; transition: background 0.25s; }
        .btn:hover { background: var(--brand-600); }
        .btn.secondary { background: #0b766d; }
        .btn.secondary:hover { background: #085e57; }

        /* Dark theme */
        body[data-theme="dark"] { background: #0b1220; color: #e6e6e6; }
        body[data-theme="dark"] .sidebar { background: #0f172a; box-shadow: none; }
        body[data-theme="dark"] .course-header, body[data-theme="dark"] .topic-card { background: #0f172a; border-color: #1f2a44; }
        body[data-theme="dark"] .topic-section p { color: #c6cbe0; }
        body[data-theme="dark"] .btn { background: #334155; }

        /* Responsive */
        @media (max-width: 960px) {
            .sidebar { position: fixed; left: 0; top: 0; bottom: 0; transform: translateX(-100%); transition: transform 0.3s ease; width: 260px; }
            .sidebar.open { transform: translateX(0); }
            .content { padding: 1.25rem; }
            .toolbar { display: flex; }
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- Main content -->
        <main class="content">
            <div class="toolbar">
                <nav class="topnav">
                    <a href="{% url 'dashboard' %}">Dashboard</a>
                    <a href="{% url 'all_topics' %}">All Topics</a>
                    {% if selected_completion and selected_completion.video_watched %}
                        <a href="{% url 'assignment_page' course.id %}">Assignments</a>
                    {% else %}
                        <a href="#" aria-disabled="true" style="opacity:.6; pointer-events:none;">Assignments</a>
                    {% endif %}
                    {% if has_mcqs %}
                        {% if selected_completion and selected_completion.video_watched %}
                            <a href="{% url 'course_mcq_topics' course.id %}">MCQs</a>
                        {% else %}
                            <a href="#" aria-disabled="true" style="opacity:.6; pointer-events:none;">MCQs</a>
                        {% endif %}
                    {% else %}
                        <a href="#" aria-disabled="true" style="opacity:.6; pointer-events:none;">MCQs</a>
                    {% endif %}
                    <a href="#">Progress</a>
                </nav>
                <a href="#" id="themeToggle" class="theme-btn" aria-label="Toggle theme">üåô</a>
            </div>
            <div class="course-header">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <h1>{{ course.title }}</h1>
                    {% if course_progress_percent is not None %}
                    <div style="text-align: right;">
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--brand-800); margin-bottom: 0.25rem;">
                            {{ course_progress_percent }}% Complete
                        </div>
                        <div style="width: 200px; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                            <div style="width: {{ course_progress_percent }}%; height: 100%; background: linear-gradient(90deg, var(--brand-600), var(--brand-800)); transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <p>{{ course.description }}</p>
                <div style="display:flex; gap: .75rem; flex-wrap: wrap; margin-top: .75rem;">
                    {% if final_exam and all_topics_completed %}
                        <a href="{% url 'final_exam' course.id %}" class="btn" style="background:#16a34a;">Start Final Exam</a>
                    {% else %}
                        <a href="#" class="btn" style="opacity:.6; pointer-events:none;">Start Final Exam (complete all chapters)</a>
                    {% endif %}
                    {% if progress and progress.final_exam_passed %}
                        <a href="{% url 'certificate' course.id %}" class="btn secondary">View Certificate</a>
                    {% endif %}
                </div>
            </div>
            <div class="content-grid" style="margin-top: 0;">
                <aside class="module-list">
                    <div class="module-list-header">Modules</div>
                    <ul class="module-items">
                        {% for item in topics_with_completion %}
                        <li class="module-item">
                            {% if item.is_unlocked %}
                                <a class="module-link {% if selected_topic and selected_topic.id == item.topic.id %}active{% endif %}"
                                   href="{% url 'course_detail' course.id %}?topic={{ item.topic.id }}">
                                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                        <span>{% if item.is_completed %}‚úì {% endif %}{{ item.topic.title }}</span>
                                        {% if item.completion %}
                                        <div style="display: flex; gap: 0.3rem; font-size: 0.75rem;">
                                            {% if item.completion.video_watched %}<span title="Video Watched">üé•</span>{% endif %}
                                            {% if item.completion.mcq_passed %}<span title="MCQ Passed">‚úÖ</span>{% endif %}
                                            {% if item.completion.assignment_submitted %}<span title="Assignment Submitted">üìù</span>{% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </a>
                            {% else %}
                                <span class="module-link" style="opacity: 0.5; cursor: not-allowed; background: #f3f4f6;">
                                    üîí {{ item.topic.title }} (Locked)
                                </span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </aside>

                <section style="margin: 0; padding: 0;">
                    {% if selected_topic %}
                    <section class="player">
                        <div class="player-header">
                            <div class="player-title">Now Playing: {{ selected_topic.title }}</div>
                            <div style="display:flex; align-items:center; gap:1rem;">
                                {% if course_progress_percent is not None %}
                                <div style="font-size:0.9rem;color:#64748b;">
                                    <strong>Course Progress: {{ course_progress_percent }}%</strong>
                                </div>
                                {% endif %}
                                {% if selected_topic %}
                                {% for item in topics_with_completion %}
                                    {% if item.topic.id == selected_topic.id and item.completion %}
                                    <div style="font-size:0.85rem;color:#16a34a;">
                                        {% if item.completion.video_watched %}üé• Video{% endif %}
                                        {% if item.completion.mcq_passed %} ‚úÖ MCQ{% endif %}
                                        {% if item.completion.assignment_submitted %} üìù Assignment{% endif %}
                                    </div>
                                    {% endif %}
                                {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        <div class="aspect">
                            {% if selected_topic.video_file %}
                                <video class="plyr__video-embed"
                                    controls
                                    controlsList="nodownload"
                                    preload="metadata"
                                    data-plyr-config='{"keyboard":{"focused":true,"global":true}}'
                                    {% if selected_topic.poster_image %}poster="{{ selected_topic.poster_image.url }}"{% endif %}>
                                    <source src="{{ selected_topic.video_file.url }}" type="video/mp4">
                                    {% if selected_topic.caption_en_file %}
                                    <track kind="captions" label="English" srclang="en" src="{{ selected_topic.caption_en_file.url }}" default>
                                    {% endif %}
                                    {% if selected_topic.caption_ta_file %}
                                    <track kind="captions" label="Tamil" srclang="ta" src="{{ selected_topic.caption_ta_file.url }}">
                                    {% endif %}
                                    {% if selected_topic.chapters_file %}
                                    <track kind="chapters" src="{{ selected_topic.chapters_file.url }}">
                                    {% endif %}
                                    Your browser does not support the video tag.
                                </video>
                            {% else %}
                                <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#94a3b8;background:#0b1220;">No video available for this topic.</div>
                            {% endif %}
                        </div>
                    </section>
                    {% endif %}

                    <div style="display:flex;gap:.5rem;flex-wrap:wrap;justify-content:flex-end;margin: 0.75rem 0 1.25rem 0;">
                        {% if selected_topic and selected_completion and selected_completion.video_watched %}
                            {% if has_topic_mcqs %}
                                <a href="{% url 'course_mcq' course.id %}?topic={{ selected_topic.id }}" class="btn" style="font-weight:600;">Start MCQ Quiz</a>
                            {% elif has_mcqs %}
                                <a href="{% url 'course_mcq' course.id %}" class="btn" style="font-weight:600;">Start MCQ Quiz</a>
                            {% endif %}
                            <a href="{% url 'assignment_page' course.id %}" class="btn secondary">Assignments</a>
                        {% else %}
                            <a href="#" class="btn" style="font-weight:600; opacity:.6; pointer-events:none;">Start MCQ Quiz</a>
                            <a href="#" class="btn secondary" style="opacity:.6; pointer-events:none;">Assignments</a>
                        {% endif %}
                        <a href="#topics" class="btn">Learning Material</a>
                    </div>

                    <section id="topics" class="topics">
                        {% for item in topics_with_completion %}
                        <div class="topic-card">
                            <h3>{{ item.topic.order }}. {{ item.topic.title }}</h3>
                            <div class="topic-section">
                                <p>
                                    {% if item.topic.video_file %}üé• Video available{% else %}<span class="no-data">No video</span>{% endif %}
                                </p>
                                <p>
                                    {% if item.topic.ppt_file %}üìä PPT available{% else %}<span class="no-data">No PPT</span>{% endif %}
                                </p>
                                <p>
                                    {% if item.topic.reference_file %}üìÑ Reference doc available{% else %}<span class="no-data">No reference</span>{% endif %}
                                </p>
                                <p>
                                    {% if item.topic.pdf_file %}üìï PDF available{% else %}<span class="no-data">No PDF</span>{% endif %}
                                </p>
                            </div>
                            <div class="topic-actions">
                                <a href="{% url 'course_detail' course.id %}?topic={{ item.topic.id }}" class="btn">Open</a>
                                {% if item.is_unlocked and item.completion and item.completion.video_watched %}
                                    {% if item.topic.id in topic_ids_with_mcqs %}
                                        <a href="{% url 'course_mcq' course.id %}?topic={{ item.topic.id }}" class="btn">MCQ</a>
                                    {% endif %}
                                    <a href="{% url 'assignment_page' course.id %}" class="btn secondary">Assignments</a>
                                {% else %}
                                    <a href="#" class="btn" style="opacity:.6; pointer-events:none;">MCQ</a>
                                    <a href="#" class="btn secondary" style="opacity:.6; pointer-events:none;">Assignments</a>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </section>
                </section>
            </div>

        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.polyfilled.min.js"></script>
    <script>
        // Sidebar mobile toggle
        const sidebar = document.querySelector('.sidebar');
        const menuToggle = document.getElementById('menuToggle');
        if (menuToggle) {
            menuToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
        }
        // Click outside to close on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 960 && sidebar.classList.contains('open')) {
                const within = sidebar.contains(e.target) || (menuToggle && menuToggle.contains(e.target));
                if (!within) sidebar.classList.remove('open');
            }
        });

        // Theme toggle with persistence
        const themeToggle = document.getElementById('themeToggle');
        const setTheme = (t)=> document.body.setAttribute('data-theme', t);
        const stored = localStorage.getItem('theme');
        if (stored === 'dark') setTheme('dark');
        if (themeToggle) {
            themeToggle.addEventListener('click', (e)=>{
                e.preventDefault();
                const next = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                if (next === 'light') document.body.removeAttribute('data-theme'); else setTheme('dark');
                localStorage.setItem('theme', next);
                themeToggle.textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            });
        }

        // Plyr initialization with video tracking
        const players = Array.from(document.querySelectorAll('video')).map(el => {
            const player = new Plyr(el, {
                captions: { active: true, update: true },
                keyboard: { focused: true, global: true },
                tooltips: { controls: true, seek: true }
            });
            
            // Track video watching for progress
            let tracked = false;
            const topicId = new URLSearchParams(window.location.search).get('topic');
            const baseUrl = window.location.pathname;
            
            const trackVideoWatched = () => {
                if (!tracked) {
                    tracked = true;
                    const url = baseUrl + '?topic=' + topicId + '&video_watched=true';
                    fetch(url, {
                        method: 'GET',
                        headers: {'X-Requested-With': 'XMLHttpRequest'}
                    }).then(() => {
                        // Refresh progress display after 1 second
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    });
                }
            };
            
            player.on('play', () => {
                // Track after 30 seconds or when video ends
                if (!tracked) {
                    const checkProgress = () => {
                        if (player.currentTime >= 30 || player.ended) {
                            trackVideoWatched();
                            player.off('timeupdate', checkProgress);
                        }
                    };
                    player.on('timeupdate', checkProgress);
                }
            });
            
            player.on('ended', () => {
                trackVideoWatched();
            });
            
            return player;
        });
    </script>
</body>
</html>
