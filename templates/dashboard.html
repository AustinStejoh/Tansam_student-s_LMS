{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tansam School - Student Dashboard</title>
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f9fafb; color: #1f2937;}
        .header { background-color: #1e3a8a; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-left, .header-right, .user-menu { display: flex; align-items: center; gap: 1rem; }
        .header-title h1 { font-size: 1.5rem; margin: 0; }
        .header-title p { font-size: 0.8rem; margin: 0; color: #9ca3af; }
        .logo { width: 40px; height: 40px; }
        .notification-icon { position: relative; cursor: pointer; }
        .notification-badge { position: absolute; top: -5px; right: -8px; background-color: #ef4444; color: white; border-radius: 50%; font-size: 0.7rem; padding: 2px 5px; }
        .user-avatar { width: 40px; height: 40px; background-color: #fbbf24; color: #1e3a8a; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; }
        .user-info h3 { font-size: 1rem; margin: 0; }
        .user-info p { font-size: 0.8rem; margin: 0; color: #d1d5db; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .welcome-card { background-color: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .welcome-card h2 { color: #1e3a8a; margin-bottom: 0.5rem; }
        .welcome-card p { margin-bottom: 0.5rem; color: #4b5563; }
        .last-access { font-size: 0.8rem; color: #6b7280; margin-top: 1rem; }
        .dashboard-grid { display: grid; grid-template-columns: 280px 1fr; gap: 2rem; }
        .profile-card { background-color: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; }
        .profile-avatar { width: 80px; height: 80px; background-color: #fbbf24; color: #1e3a8a; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 2rem; margin: 0 auto 1rem; }
        .profile-name { font-size: 1.2rem; font-weight: 600; margin-bottom: 0.25rem; }
        .profile-grade { font-size: 0.9rem; color: #6b7280; margin-bottom: 1.5rem; }
        .profile-stats { text-align: left; }
        .stat-item { display: flex; justify-content: space-between; font-size: 0.9rem; padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb; }
        .stat-item:last-child { border: none; }
        .stat-label { color: #4b5563; }
        .stat-value { font-weight: 500; }
        .main-content { display: flex; flex-direction: column; gap: 2rem; }
        .progress-section { background-color: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .section-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 1.5rem; border-bottom: 2px solid #fbbf24; padding-bottom: 0.5rem; display: inline-block;}
        .progress-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .progress-card { background-color: #f3f4f6; padding: 1rem; border-radius: 6px; }
        .progress-card-header { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 0.75rem; color: #4b5563; font-weight: 500;}
        .progress-bar-container { height: 8px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: #3b82f6; border-radius: 4px; transition: width 0.5s ease-in-out; }
        .progress-card.success .progress-bar { background-color: #22c55e; }
        .progress-card.warning .progress-bar { background-color: #f59e0b; }
        .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
        .quick-action-btn { background-color: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 1rem; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .quick-action-btn:hover { transform: translateY(-3px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .quick-action-icon { font-size: 1.5rem; }
        .quick-action-text h4 { font-size: 1rem; margin: 0 0 0.25rem 0; }
        .quick-action-text p { font-size: 0.8rem; margin: 0; color: #6b7280; }
        .courses-section { background-color: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .courses-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;}
        .course-card { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; background-color: #f9fafb; margin-bottom: 1rem; cursor:pointer; transition: box-shadow 0.2s;}
        .course-card:hover { box-shadow: 0 4px 12px rgba(30,58,138,0.11);}
        .course-header { background-color: #dbeafe; padding: 1rem 1.25rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb;}
        .course-header.impact { background-color: #dcfce7; }
        .course-title { font-weight: 600; font-size: 1.1rem; color: #1e3a8a; }
        .course-header.impact .course-title { color: #15803d; }
        .course-meta { font-size: 0.85rem; color: #4b5563; }
        .course-body { padding: 1.25rem; min-height: 200px; }
        .course-progress { margin: 1rem 0; font-size: 0.85rem; color: #4b5563; text-align: right; }
        .course-progress .progress-bar-container { height: 6px; background: #e5e7eb; border-radius: 10px; margin-top: 0.25rem; }
        .course-progress .progress-bar { height: 100%; background: linear-gradient(90deg, #2563eb, #60a5fa); border-radius: 10px; transition: width 1s ease; }
        .course-progress.impact .progress-bar { background: linear-gradient(90deg, #16a34a, #4ade80); }
        .topic-list { list-style: none; font-size: 0.9rem; color: #374151; max-height: 150px; overflow-y: auto; text-align: left; padding-left: 0; }
        .topic-list li { padding: 0.4rem 0; border-bottom: 1px dashed #e5e7eb; }
        .topic-list li:last-child { border: none; }
        .topic-list li.completed::before { content: 'âœ“ '; color: #16a34a; font-weight: bold; margin-right: 0.3em; }
        .debug-info { color: #dc3545; font-size: 0.8rem; margin-top: 1rem; }
        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .profile-card { order: -1; margin-bottom: 2rem;}
        }
        @media (max-width: 600px) {
            .header { flex-direction: column; gap: 1rem; padding: 1rem; }
            .header-right { margin-top: 0.5rem; }
            .welcome-card h2 { font-size: 1.3rem; }
        }
        .chatbot-toggle-btn {
            background: #fff;
            color: #1e3a8a;
            border: 2px solid #1e3a8a;
            border-radius: 50px;
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            font-weight: 600;
            margin-left: 1rem;
            transition: background 0.2s, color 0.2s;
        }
        .chatbot-toggle-btn:hover {
            background: #1e3a8a;
            color: #fff;
        }
        .logout-btn {
            background: #fff;
            color: #ef4444;
            border: 2px solid #ef4444;
            border-radius: 50px;
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            font-weight: 600;
            margin-left: 0.5rem;
            transition: background 0.2s, color 0.2s;
        }
        .logout-btn:hover {
            background: #ef4444;
            color: #fff;
        }
        .chatbot-widget {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 340px;
            max-width: 96vw;
            background: #fff;
            box-shadow: 0 8px 32px rgba(30,58,138,0.2);
            border-radius: 12px;
            overflow: hidden;
            z-index: 1000;
            display: none;
            flex-direction: column;
        }
        .chatbot-header {
            background: #1e3a8a;
            color: #fff;
            padding: 0.8rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chatbot-title {
            font-size: 1.1rem;
            font-weight: bold;
        }
        .chatbot-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
        }
        .chatbot-body {
            flex: 1;
            padding: 1rem;
            background: #f1f5f9;
            max-height: 320px;
            overflow-y: auto;
            font-size: 0.97rem;
        }
        .chatbot-message {
            margin-bottom: 0.9rem;
            line-height: 1.5;
        }
        .chatbot-message.user { text-align: right; }
        .chatbot-message.bot { text-align: left; color: #1e3a8a; }
        .chatbot-input-bar {
            display: flex;
            border-top: 1px solid #e5e7eb;
            background: #fff;
        }
        .chatbot-input-bar input {
            border: none;
            flex: 1;
            padding: 0.8rem;
            font-size: 1rem;
            outline: none;
            background: transparent;
        }
        .chatbot-input-bar button {
            background: #1e3a8a;
            color: #fff;
            border: none;
            padding: 0.8rem 1.1rem;
            font-size: 1rem;
            border-radius: 0 12px 12px 0;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <svg class="logo" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="48" fill="#1e3a8a" stroke="#f59e0b" stroke-width="2"/>
                <text x="50" y="55" text-anchor="middle" font-size="22" fill="#fff" font-weight="bold">4.0</text>
                <text x="50" y="75" text-anchor="middle" font-size="12" fill="#fbbf24" font-weight="bold">READY</text>
            </svg>
            <div class="header-title">
                <h1>Tansam School</h1>
                <p>E-Learning Dashboard</p>
            </div>
        </div>
        <div class="header-right">
            <div class="notification-icon">ðŸ””<span class="notification-badge">{{ notifications|default:"1" }}</span></div>
            <div class="user-menu">
                <div class="user-avatar">{{ user.name|slice:":1" }}</div>
                <div class="user-info">
                    <h3>{{ user.name }}</h3>
                    <p>Grade {{ user.class_level }}</p>
                </div>
            </div>
            <button class="chatbot-toggle-btn" id="chatbotToggleBtn" title="Ask SchoolBot">ðŸ’¬ Chat</button>
            <form method="post" action="{% url 'logout' %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="logout-btn" title="Logout">Logout</button>
            </form>
        </div>
    </header>
    <div class="container">
        <div class="welcome-card">
            <h2>Welcome back, {{ user.name }}! ðŸ‘‹</h2>
            <p>Your personalized learning journey starts here.</p>
            <p>Explore topics, track your progress, and earn certificates as you learn.</p>
            <div class="last-access">Last accessed: {{ request.session.last_access|default:"October 21, 2025, 12:03 PM IST" }}</div>
        </div>
        <div class="dashboard-grid">
            <aside class="profile-card">
                <div class="profile-avatar">{{ user.name|slice:":1" }}</div>
                <div class="profile-name">{{ user.name }}</div>
                <div class="profile-grade">Grade {{ user.class_level }} Student</div>
                <div class="profile-stats">
                    <div class="stat-item"><span class="stat-label">Student ID</span><span class="stat-value">#{{ user.id|default:"68042" }}</span></div>
                    <div class="stat-item"><span class="stat-label">Enrolled Courses</span><span class="stat-value">{{ courses|length }}</span></div>
                    <div class="stat-item"><span class="stat-label">Overall Progress</span><span class="stat-value">{{ overall_progress|floatformat:1 }}%</span></div>
                    <div class="stat-item"><span class="stat-label">Certificates</span><span class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">Assignments Due</span><span class="stat-value">{{ user.assignments_due|default:"0" }}</span></div>
                </div>
            </aside>
            <div class="main-content">
                <section class="progress-section">
                    <h2 class="section-title">Your Progress Overview</h2>
                    <div class="progress-grid">
                        <div class="progress-card">
                            <div class="progress-card-header"><span>Overall Completion</span><span>{{ overall_progress|floatformat:1 }}%</span></div>
                            <div class="progress-bar-container"><div class="progress-bar" style="width: {{ overall_progress|default:0 }}%"></div></div>
                        </div>
                        <div class="progress-card success">
                            <div class="progress-card-header"><span>Assignments Submitted</span><span>--%</span></div>
                            <div class="progress-bar-container"><div class="progress-bar success" style="width: 0%"></div></div>
                        </div>
                        <div class="progress-card warning">
                            <div class="progress-card-header"><span>Average Grade</span><span>--</span></div>
                            <div class="progress-bar-container"><div class="progress-bar warning" style="width: 0%"></div></div>
                        </div>
                    </div>
                </section>
                <div class="quick-actions">
                    <div class="quick-action-btn"><span class="quick-action-icon">ðŸ§ </span><div class="quick-action-text"><h4>Start Learning</h4><p>Explore your courses</p></div></div>
                    <div class="quick-action-btn"><span class="quick-action-icon">ðŸ’¡</span><div class="quick-action-text"><h4>Track Progress</h4><p>Monitor your goals</p></div></div>
                    <div class="quick-action-btn"><span class="quick-action-icon">ðŸ“ˆ</span><div class="quick-action-text"><h4>View Stats</h4><p>Check your performance</p></div></div>
                    <div class="quick-action-btn"><span class="quick-action-icon">ðŸ’¬</span><div class="quick-action-text"><h4>Contact Mentor</h4><p>Ask your queries</p></div></div>
                </div>
                <section class="courses-section">
                    <h2 class="section-title">Your Courses</h2>
                    <div class="courses-grid">
                        {% for cp in course_progress %}
                        <a href="{% url 'course_detail' cp.course.id %}" style="text-decoration:none; color:inherit;">
                            <div class="course-card">
                                <div class="course-header {% if cp.course.title == 'IMPACT: Life Skills' %}impact{% endif %}">
                                    <div class="course-title">{{ cp.course.title }}</div>
                                    <div class="course-meta">Grade {{ user.class_level }}</div>
                                </div>
                                <div class="course-body">
                                    {% if cp.course.image %}
                                        <img src="{{ cp.course.image.url }}" alt="{{ cp.course.title }}" style="width:100%; height:160px; object-fit:cover; border-radius:6px; margin-bottom:1rem;">
                                    {% endif %}
                                    <p style="font-size:0.9rem; color:#374151; margin-bottom:1rem;">{{ cp.course.description|truncatewords:20 }}</p>
                                    <div class="course-progress {% if cp.course.title == 'IMPACT: Life Skills' %}impact{% endif %}">
                                        {{ cp.overall_progress|floatformat:1 }}% Complete
                                        <div class="progress-bar-container">
                                            <div class="progress-bar {% if cp.course.title == 'IMPACT: Life Skills' %}impact{% endif %}" style="width: {{ cp.overall_progress|default:0 }}%"></div>
                                        </div>
                                    </div>
                                    <ul class="topic-list">
                                        {% for topic in cp.course.topics.all %}
                                            <li class="{% if topic.id in completed_topic_ids %}completed{% endif %}">{{ topic.title }}</li>
                                        {% empty %}
                                            <li>No topics available for this course.</li>
                                        {% endfor %}
                                    </ul>
                                    <div class="debug-info">
                                        Debug: Course={{ cp.course.title }}, Topics Count={{ cp.course.topics.count }}
                                    </div>
                                </div>
                            </div>
                        </a>
                        {% empty %}
                        <p>No courses available.</p>
                        {% endfor %}
                    </div>
                </section>
            </div>
        </div>
    </div>
    <!-- Chatbot Widget -->
    <div class="chatbot-widget" id="chatbotWidget">
        <div class="chatbot-header">
            <span class="chatbot-title">SchoolBot</span>
            <button class="chatbot-close" id="chatbotCloseBtn" title="Close">&times;</button>
        </div>
        <div class="chatbot-body" id="chatbotBody">
            <div class="chatbot-message bot">Hi {{ user.name|default:"student" }}! ðŸ‘‹<br>How can I help you today?</div>
        </div>
        <form class="chatbot-input-bar" id="chatbotForm" autocomplete="off">
            <input type="text" id="chatbotInput" placeholder="Type your question..." required />
            <button type="submit">Send</button>
        </form>
    </div>
    <script>
        // Tab switching (if tabs exist)
        const tabs = document.querySelectorAll('.tab-button');
        const contents = document.querySelectorAll('.tab-content');
        tabs.forEach(btn => {
            btn.addEventListener('click', () => {
                tabs.forEach(b => b.classList.remove('active'));
                contents.forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });
        // Animate progress bars on load
        window.addEventListener('load', () => {
            const progressBars = document.querySelectorAll('.progress-bar');
            progressBars.forEach(bar => {
                const width = bar.style.width;
                bar.style.width = '0%';
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        bar.style.width = width;
                    });
                });
            });
        });
        // Chatbot logic
        const chatbotToggleBtn = document.getElementById('chatbotToggleBtn');
        const chatbotWidget = document.getElementById('chatbotWidget');
        const chatbotCloseBtn = document.getElementById('chatbotCloseBtn');
        const chatbotForm = document.getElementById('chatbotForm');
        const chatbotInput = document.getElementById('chatbotInput');
        const chatbotBody = document.getElementById('chatbotBody');
        chatbotToggleBtn.addEventListener('click', () => {
            chatbotWidget.style.display = chatbotWidget.style.display === 'flex' ? 'none' : 'flex';
            chatbotInput.focus();
        });
        chatbotCloseBtn.addEventListener('click', () => {
            chatbotWidget.style.display = 'none';
        });
        function botReply(userMsg) {
            let reply = "Sorry, I'm still learning. Please contact your mentor for urgent help.";
            const msgLC = userMsg.toLowerCase();
            if (msgLC.includes("progress")) reply = "You can check your progress in the Progress Overview section above.";
            else if (msgLC.includes("course")) reply = "All your enrolled courses are listed in the Courses section!";
            else if (msgLC.includes("mentor")) reply = "You can contact your mentor using the 'Contact Mentor' button.";
            else if (msgLC.includes("certificate")) reply = "Certificates are awarded after completing a course.";
            else if (msgLC.includes("assignment")) reply = "Assignments and their due dates are shown in your profile card and course details.";
            else if (msgLC.includes("hello") || msgLC.includes("hi")) reply = "Hello! How can I help you today?";
            else if (msgLC.includes("help")) reply = "I'm here to help! Ask me about your courses, progress, or assignments.";
            setTimeout(() => {
                addMessage(reply, 'bot');
            }, 500);
        }
        function addMessage(text, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chatbot-message ' + sender;
            msgDiv.innerHTML = text;
            chatbotBody.appendChild(msgDiv);
            chatbotBody.scrollTop = chatbotBody.scrollHeight;
        }
        chatbotForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const userMsg = chatbotInput.value.trim();
            if (!userMsg) return;
            addMessage(userMsg, 'user');
            chatbotInput.value = '';
            botReply(userMsg);
        });
    </script>
</body>
</html>